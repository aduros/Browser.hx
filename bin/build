#!/usr/bin/env perl
#
# Forked from JSX's extern generator and adapted to Haxe
# https://github.com/jsx/JSX

use 5.10.0;
use strict;
use warnings;
use File::Path qw(mkpath);
use Fatal qw(open close);
use File::Basename qw(dirname);
use Storable qw(lock_retrieve);
use Tie::IxHash;
use POSIX qw(strftime);

# the order is important!

my $root = dirname(__FILE__) . "/..";
unlink "$root/bin/.idl2hx.bin";

my @specs = (
    # ['js.Test' =>
    #     "$root/idl/domcore.idl",
    # ],
    ['js.Browser' =>
        # # DOM spec
        # #'http://www.w3.org/TR/DOM-Level-3-Core/idl/dom.idl',
        'http://www.w3.org/TR/dom/',
        'http://www.w3.org/TR/DOM-Level-2-Views/idl/views.idl',
        'http://www.w3.org/TR/DOM-Level-3-Events/',
        "$root/idl/events.idl",

        'http://www.w3.org/TR/XMLHttpRequest/',

        # #'http://html5labs.interoperabilitybridges.com/dom4events/', # no correct IDL

        # # CSS
        'http://dev.w3.org/csswg/cssom/',
        'http://dev.w3.org/csswg/cssom-view/',
        # "$root/idl/chrome.idl",
        # "$root/idl/firefox.idl",

        # # SVG
        # #"http://www.w3.org/TR/2011/REC-SVG11-20110816/svg.idl",

        # # HTML5
        # #'http://dev.w3.org/html5/spec/single-page.html', # too new
        'http://www.w3.org/TR/html5/single-page.html',
        'http://www.w3.org/TR/FileAPI/',
        # "$root/idl/file.idl",

        # #"http://www.w3.org/TR/webaudio/", # no correct IDL
        "http://www.w3.org/TR/touch-events/",
        "http://dev.w3.org/html5/websockets/",
        "http://dev.w3.org/geo/api/spec-source-v2.html",
        "http://dev.w3.org/html5/webstorage/",
        'http://www.w3.org/TR/selectors-api/',

        # # WebRTC has no correct IDL
        # #"http://dev.w3.org/2011/webrtc/editor/webrtc.html",
        # #"http://dev.w3.org/2011/webrtc/editor/getusermedia.html",

        # by html5.org
        "http://html5.org/specs/dom-parsing.html",

        # # graphics
        'https://www.khronos.org/registry/typedarray/specs/latest/typedarray.idl',
        'http://dev.w3.org/html5/2dcontext/',
        'https://www.khronos.org/registry/webgl/specs/latest/webgl.idl',

        # # additionals
        # "$root/idl/timers.idl",
        # "$root/idl/animation-timing.idl",
    ],
);

my $date = strftime("%B%e, %Y", localtime);
my $HEADER = <<"T";
//
// Generated on $date.

T

foreach my $spec(@specs) {
    my($class, @idls) = @{$spec};
    say "Generating $class...";

    my $externs = scalar(`$root/bin/idl2hx --continuous @idls`);
    if($? != 0) {
        die "Cannot convert @idls to JSX.\n";
    }

    my $path = $class;
    $path =~ s/\./\//g;
    $path = "haxe/$path.hx";

    my $dir = substr($path, 0, rindex($path, "/")+1);
    mkpath($dir);

    open my($fh), ">", "$path";
    print $fh $HEADER;

    my $idx = rindex($class, ".");
    if ($idx >= 0) {
        my $package = substr($class, 0, $idx);
        print $fh "package $package;\n\n";
    }

    print $fh $externs;
    close $fh;

    # Run it through the compiler to validate syntax
    `haxe -js test.js --no-output -cp haxe $class`;
    if($? != 0) {
        die "idl2hx generated invalid code!\n";
    }
}
